#!/usr/bin/env bash
# =============================================================================
# Tessella Kiosk-Skript
# Startet Firefox im Kiosk-Modus und verbindet sich zum Tessella-Server.
# Generiert von Ansible – nicht manuell bearbeiten!
# =============================================================================

set -euo pipefail

TESSELLA_URL="{{ tessella_client_kiosk_url }}"
TESSELLA_SERVER="{{ tessella_server_url }}"
MAX_WAIT=120
STARTUP_DELAY=5

# --- Logging einrichten ------------------------------------------------------
LOG_DIR="${HOME}/.local/share/tessella"
LOG_FILE="${LOG_DIR}/kiosk.log"
mkdir -p "${LOG_DIR}"

# Alte Log-Datei rotieren (max 1 Backup behalten)
if [ -f "${LOG_FILE}" ]; then
    mv -f "${LOG_FILE}" "${LOG_FILE}.1"
fi

exec > >(tee -a "${LOG_FILE}") 2>&1
echo "============================================="
echo "[INFO] Tessella Kiosk gestartet: $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================================="

# --- Warten bis Desktop-Umgebung bereit ist ---------------------------------
echo "[INFO] Warte ${STARTUP_DELAY}s auf Desktop-Umgebung ..."
sleep "${STARTUP_DELAY}"

# --- Gespeicherte Xfce-Session löschen (verhindert Session-Restore statt Autostart) ---
if [ -d "${HOME}/.cache/sessions" ]; then
    echo "[INFO] Lösche gespeicherte Xfce-Session ..."
    rm -rf "${HOME}/.cache/sessions"
fi

# --- Firefox-Binary erkennen -------------------------------------------------
if command -v firefox-esr &>/dev/null; then
    FIREFOX_BIN="firefox-esr"
elif command -v firefox &>/dev/null; then
    FIREFOX_BIN="firefox"
else
    echo "[FEHLER] Weder firefox-esr noch firefox gefunden!" >&2
    exit 1
fi

echo "[INFO] Verwende Browser: ${FIREFOX_BIN}"
echo "[INFO] DISPLAY=${DISPLAY:-nicht gesetzt}"

# --- Auf Tessella-Server warten ----------------------------------------------
echo "[INFO] Warte auf Tessella-Server (${TESSELLA_SERVER}) ..."
SECONDS_WAITED=0
until curl -s --max-time 2 "${TESSELLA_SERVER}" >/dev/null 2>&1; do
    if [ "${SECONDS_WAITED}" -ge "${MAX_WAIT}" ]; then
        echo "[FEHLER] Tessella-Server nach ${MAX_WAIT}s nicht erreichbar!" >&2
        exit 1
    fi
    sleep 2
    SECONDS_WAITED=$((SECONDS_WAITED + 2))
done
echo "[INFO] Tessella-Server erreichbar nach ${SECONDS_WAITED}s."

# --- Endlosschleife: Firefox im Kiosk-Modus ----------------------------------
while true; do
    # Lock-Dateien und Session-Recovery aufräumen (verhindert Probleme nach unsauberem Neustart)
    find "${HOME}/.mozilla/firefox/" -name ".parentlock" -delete 2>/dev/null || true
    find "${HOME}/.mozilla/firefox/" -name "lock" -delete 2>/dev/null || true
    find "${HOME}/.mozilla/firefox/" -name "sessionstore.jsonlz4" -delete 2>/dev/null || true
    find "${HOME}/.mozilla/firefox/" -name "sessionstore-backups" -type d -exec rm -rf {} + 2>/dev/null || true

    echo "[INFO] Starte ${FIREFOX_BIN} im Kiosk-Modus ... ($(date '+%H:%M:%S'))"
    ${FIREFOX_BIN} --kiosk "${TESSELLA_URL}" || true

    echo "[WARNUNG] Firefox wurde beendet – Neustart in 3 Sekunden ... ($(date '+%H:%M:%S'))"
    sleep 3
done
